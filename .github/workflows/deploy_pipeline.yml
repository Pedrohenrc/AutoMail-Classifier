name: Deploy to Railway

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run linting
      run: |
        pip install flake8
        flake8 app --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 app --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

    - name: Test application startup
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python -c "from app.main import app; print('‚úÖ App imports successfully')"

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: automail-classifier:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        docker build -t automail-classifier:test .
        docker run -d -p 8000:8000 \
          -e GEMINI_API_KEY=test_key \
          --name test_container \
          automail-classifier:test
        sleep 10
        docker logs test_container
        docker stop test_container

  deploy:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Railway CLI
      run: |
        npm i -g @railway/cli

    - name: Deploy to Railway
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        railway link ${{ secrets.RAILWAY_PROJECT_ID }}
        railway up --detach

    - name: Wait for deployment
      run: |
        echo "‚è≥ Aguardando deploy completar..."
        sleep 45

    - name: Verify deployment
      env:
        RAILWAY_SERVICE_URL: ${{ secrets.RAILWAY_SERVICE_URL }}
      run: |
        echo "üîç Verificando deployment..."
        max_attempts=10
        attempt=0
        
        while [ $attempt -lt $max_attempts ]; do
          response=$(curl -s -o /dev/null -w "%{http_code}" $RAILWAY_SERVICE_URL || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Deployment verificado com sucesso!"
            exit 0
          fi
          
          echo "Tentativa $((attempt + 1))/$max_attempts - Status: $response"
          attempt=$((attempt + 1))
          sleep 10
        done
        
        echo "‚ùå Deployment falhou ap√≥s $max_attempts tentativas"
        exit 1

    - name: Notify deployment success
      if: success()
      run: |
        echo "üéâ Deploy realizado com sucesso!"
        echo "üåê URL: ${{ secrets.RAILWAY_SERVICE_URL }}"

    - name: Notify deployment failure
      if: failure()
      run: |
        echo "‚ùå Deploy falhou. Verifique os logs acima."